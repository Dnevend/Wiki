---
slug: attention-and-extension
title: ä¸ºé©å‘½ä¿æŠ¤â€œè§†â€åŠ›
description: æ³¨æ„åŠ›ä¸æµè§ˆå™¨æ’ä»¶å¼€å‘å°è®°
date: 2024-10-28
authors: [Dnevend]
tags: [extension]
---

export const Music = () => (
  <iframe
    frameborder="no"
    border="0"
    marginwidth="0"
    marginheight="0"
    width="100%"
    height="86"
    src="//music.163.com/outchain/player?type=2&id=1996073639&auto=1&height=66"
  />
);

> â€œè§‚å¯Ÿè‡ªå·±å‘ç°ï¼Œå…¶å®ä¸æ˜¯æ³¨æ„åŠ›ä¸é›†ä¸­ï¼Œè€Œæ˜¯æ³¨æ„åŠ›éå¸¸å®¹æ˜“é›†ä¸­ï¼Œæ¯”å¦‚ä¸€ä¸ªå°çº¢ç‚¹ï¼Œä¸€æ¡ä¿¡æ¯ï¼Œéƒ½ä¼šè®©è‡ªå·±ä»æ”¾ç©ºçš„çŠ¶æ€ä¸­è·³å‡ºæ¥ï¼Œè¿›å…¥åˆ°å…·ä½“çš„äº‹ç‰©ä¸­å»ã€‚
> æˆ–è®¸é—®é¢˜ä¸è¯¥æ˜¯å¦‚ä½•é›†ä¸­æ³¨æ„åŠ›ï¼Œè€Œæ˜¯æƒ³åŠæ³•æŠŠç¯å¢ƒä¸­å®¹æ˜“å¸å¼•æ³¨æ„åŠ›çš„äº‹ç‰©æŒªæ‰ã€‚
> æ›´æ·±å¤„çš„åŸå› ï¼Œåˆ™æ˜¯è¿™äº›è‡ªå·±å¯¹äºã€Œå­˜åœ¨ã€çš„ç„¦è™‘ï¼Œæ‰€ä»¥ä»»ä½•ç¤¾äº¤åª’ä½“/å·¥å…·çš„åé¦ˆï¼Œæ€»æ˜¯èƒ½ç¬¬ä¸€æ—¶é—´å¾—åˆ°è‡ªå·±å…³æ³¨åŠè¡ŒåŠ¨ï¼Œä»¥ä¾¿å†æ¬¡ç¡®è®¤è‡ªå·±ã€Œå­˜åœ¨ã€ä¸”ã€Œæœ‰ä»·å€¼ã€ã€‚â€
> â€”â€” äº§å“æ²‰æ€å½• Vol.029

![](./cover.png)

<Music />

## å‰è¨€

&emsp;&emsp;ä¿¡æ¯æˆç˜¾å’Œæ³¨æ„åŠ›çš„å¤ºå–ï¼Œåœ¨äº’è”ç½‘ä¸Šï¼Œå¹³å°å’Œç”¨æˆ·ä¹‹é—´äº’ç›¸å½¢æˆäº†å½¼æ­¤åŒæ„çš„åŠ¿åŠ›ï¼š
å¹³å°é€šè¿‡è®¾è®¡äº§å“çš„ç»†èŠ‚ç»™ç”¨æˆ·ä»¥ä¿¡æ¯åé¦ˆï¼ˆå¦‚å°çº¢ç‚¹ï¼Œç²¾å‡†çš„å†…å®¹æ¨èï¼‰ä½¿ç”¨æˆ·å…»æˆå¯¹è¿™ç§åé¦ˆæœºåˆ¶çš„ä¹ æƒ¯ï¼Œæ¥ä¿å­˜ç”¨æˆ·çš„æ´»è·ƒåº¦ï¼›
ä»ç”¨æˆ·è§’åº¦ï¼Œä¸ºäº†æ›´å¤šçš„æµé‡çš„åª’ä½“å’Œå¸å·ï¼Œåœ¨å‘å¸ƒçš„å†…å®¹ä¸­ç²¾å¿ƒçš„æŒ‘é€‰å’Œè®¾è®¡ï¼Œç©¿æ’ä¸€äº›å¯èƒ½æ— å…³è”ç”šè‡³å¸å¼•æ€§çš„å›¾ç‰‡ã€‚
å›¾ç‰‡çš„æ»¥ç”¨å’Œè§†é¢‘çš„å¹²æ‰°ï¼Œå½¢æˆäº†ä¸€ç§å™ªéŸ³ï¼Œä½¿å¾—çº¯æ–‡å­—çš„é˜…è¯»å’Œè¡¨è¾¾èƒ½åŠ›åœ¨è¿™è§†è§‰çš„è½¬ç§»è¿åŠ¨ä¸­é€æ¸å‰Šå¼±ã€‚

&emsp;&emsp;å¦‚ä½•è·å–æ›´å¤šçš„æ³¨æ„åŠ›ä¸»åŠ¨æƒï¼Œä¿æŠ¤è‡ªå·±çš„æ—¶é—´å’Œè¡Œä¸ºä»·å€¼ï¼Œå°±åƒåšçœ¼ä¿å¥æ“ä¸€æ ·ï¼Œæ˜¯åœ¨â€œè¯¾å‰â€éœ€è¦é€æ¸çš„å…»æˆè‰¯å¥½ä¹ æƒ¯ã€‚

&emsp;&emsp;å¦å¤–æ¨ç‰¹è¿™æ ·çš„å†…å®¹å¼€æ”¾çš„å¹³å°ï¼Œåœ¨å…¬å…±åœºåˆæµè§ˆæ—¶ï¼Œæœ‰å¯èƒ½è·³å‡ºä¸€ä¸¤æ¡ä¸åˆæ—¶å®œçš„å›¾ç‰‡ï¼Œè®©è‡ªå·±è€è„¸ä¸€çº¢æˆ–æªæ‰‹ä¸åŠã€‚

&emsp;&emsp;å› ä¸ºè¿™æ ·çš„å‡ºå‘ç‚¹ï¼Œé¡ºæ‰‹ä¹Ÿæƒ³å°è¯•ä¸‹æµè§ˆå™¨æ’ä»¶çš„å¼€å‘ï¼Œä¾¿äº§ç”Ÿäº† [X-Comfort-Browser](https://github.com/dnevend/x-comfort-browse/) è¿™ä¸ªé€›æ¨ç‰¹çš„å°å·¥å…·ã€‚

## å¼€å‘

### æ¡†æ¶é€‰æ‹©

&emsp;&emsp;åœ¨æ’ä»¶é˜µè¥ï¼ŒWebkitï¼ˆChromeã€Edgeã€Safariã€360...ï¼‰å’Œ Geckoï¼ˆFirefoxï¼‰ä¸¤ç§ä¸åŒå†…æ ¸çš„æµè§ˆå™¨åˆ†å ä¸¤å£æ±Ÿå±±ã€‚å¼€å‘æ¨¡å¼ä¹Ÿå­˜åœ¨å·®å¼‚ï¼Œå¥½åœ¨å·²æœ‰æˆç†Ÿçš„æ¡†æ¶å¯ä»¥å…¼å®¹å¼€å‘ï¼Œèƒ½çœå»ä¸å°‘å¼€å‘å‰çš„çäº‹ã€‚

[Plasmo (10.5k)](https://www.plasmo.com/) å’Œ [WXT (4.4k)](https://wxt.dev/) å¯¹ Typescript å’Œå¤šç§å‰ç«¯æ¡†æ¶éƒ½åšäº†æ”¯æŒï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„æŠ€æœ¯åå¥½æ¥è¿›è¡Œé€‰æ‹©ã€‚

åªå› ä¸ºæ˜¯å…ˆäº†è§£åˆ°äº† WXTï¼Œæ‰€ä»¥è¿™ä¸ªæ’ä»¶å°±åŸºäº WXT æ¥è¿›è¡Œå¼€å‘ã€‚

### æ’ä»¶æ„æˆ

- Manifest.json é…ç½®æ–‡ä»¶ï¼šå®šä¹‰æ’ä»¶çš„åŸºæœ¬ä¿¡æ¯å’Œæƒé™ã€‚

- Popup å¼¹çª—é¡µé¢ï¼šç”¨æˆ·ç•Œé¢ï¼Œå±•ç¤ºä¿¡æ¯å’Œæ¥æ”¶ç”¨æˆ·è¾“å…¥ã€‚

- Content Scriptï¼šå†…å®¹è„šæœ¬ï¼Œç”¨äºä¸ç½‘é¡µå†…å®¹äº¤äº’ã€‚

- Background Scriptï¼šåå°è„šæœ¬ï¼Œå¤„ç†é•¿æœŸä»»åŠ¡å’Œäº‹ä»¶ã€‚

- å…¶ä»–ç»„ä»¶ï¼šå¦‚ Options é¡µé¢ã€Browser Actionã€Page Actionã€é€šä¿¡æœºåˆ¶ç­‰ã€‚

### æ ¸å¿ƒä»£ç 

```typescript title="content.ts"
import { defineContentScript } from "wxt/sandbox";
import { defaultBlur, storageKeys } from "@/const";
import { createButton } from "@/utils";

const BLUR_EMOJI = "ğŸ‘€";
const UN_BLUR_EMOJI = "ğŸ™ˆ";

// å…ƒç´ çŠ¶æ€
const statusMap = new Map<string, boolean>();

// èµ„æºé€‰æ‹©å™¨ï¼ˆéœ€è¦è¢«æ¨¡ç³Šå±è”½çš„åª’ä½“èµ„æºï¼‰
const selectors = [
  '[data-testid="tweetPhoto"]',
  '[data-testid="videoComponent"]',
  '[data-testid="videoPlayer"]',
  '[data-testid="card.layoutLarge.media"]',
  '[data-testid="collection-hero-image"]',
  '[data-testid="article-cover-image"]',
];

async function handleElements() {
  const enable = (await storage.getItem<boolean>(storageKeys.enable)) ?? true;
  const blur = (await storage.getItem<number>(storageKeys.blur)) ?? defaultBlur;

  selectors.forEach((selector) => {
    let elements: HTMLElement[] = Array.from(
      document.querySelectorAll(selector)
    );

    elements.forEach((element) => {
      let current = element;
      let hasBlur = false;

      while (current.parentElement !== null) {
        current = current.parentElement;
        if (current.matches(selectors.join(","))) {
          hasBlur = true;
          break;
        }
      }

      // æ£€æµ‹æ˜¯å¦å·²å­˜åœ¨è¢«å¤„ç†çš„çˆ¶çº§
      if (hasBlur) return;

      let comfortId = element.getAttribute("data-comfort-id");

      if (!comfortId) {
        // æ ‡è®°å¾…å¤„ç†å…ƒç´ ï¼Œç”Ÿæˆå”¯ä¸€ID
        comfortId = crypto.randomUUID();
        element.setAttribute("data-comfort-id", comfortId);

        // æ·»åŠ æŒ‰é’®æ‰‹åŠ¨åˆ‡æ¢å…ƒç´ çŠ¶æ€
        const button = createButton(comfortId, handleElements);
        button.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();

          const newStatus = !statusMap.get(comfortId!);

          statusMap.set(comfortId!, newStatus);

          if (newStatus) {
            element.style.filter = `blur(${blur}px)`;
            button.innerText = BLUR_EMOJI;
          } else {
            element.style.filter = "none";
            button.innerText = UN_BLUR_EMOJI;
          }
        };

        element.parentElement?.insertBefore(button, element);
      }

      // ä¿å­˜å…ƒç´ çš„æ¨¡ç³ŠçŠ¶æ€
      if (!statusMap.has(comfortId)) {
        statusMap.set(comfortId, enable);
      }

      const targetElement = element as HTMLElement;
      const toggleButton = document.getElementById(comfortId) as HTMLElement;

      if (!enable) {
        targetElement.style.filter = "none";
        toggleButton.style.display = "none";
        statusMap.clear();
        return;
      } else {
        targetElement.style.transition = ".3s";
        toggleButton.style.display = "block";
      }

      const blurStatus = statusMap.get(comfortId);
      if (blurStatus && targetElement.style.filter !== `blur(${blur}px)`) {
        targetElement.style.filter = `blur(${blur}px)`;
        toggleButton.innerText = BLUR_EMOJI;
      }

      if (!blurStatus && targetElement.style.filter !== "none") {
        targetElement.style.filter = "none";
        toggleButton.innerText = UN_BLUR_EMOJI;
      }
    });
  });
}

export default defineContentScript({
  // åŒ¹é…è„šæœ¬ç”Ÿæ•ˆçš„åŸŸå
  matches: ["*://x.com/*"],
  // è„šæœ¬è¿è¡Œæ—¶æœº
  runAt: "document_idle",
  main(ctx) {
    console.log("Hello from X-Comfort-Browser.");

    // ç›‘å¬ è‡ªå®šä¹‰å‚æ•°å€¼ å˜åŒ–
    [storageKeys.blur, storageKeys.enable].forEach((key) => {
      storage.watch<number | boolean>(key, (v) => {
        handleElements();
      });
    });

    // ç›‘å¬ é¡µé¢å…ƒç´  å˜åŒ–
    const observer = new MutationObserver(() => handleElements());
    observer.observe(document.body, { childList: true, subtree: true });
  },
});
```

## å¼•ç”¨

- [ç‚¹å‡»è®¿é—®é¡¹ç›®å¼€æºåœ°å€](https://github.com/dnevend/x-comfort-browse/)

- [ç‚¹å‡»è®¿é—®æ’ä»¶å‘å¸ƒåœ°å€](https://chromewebstore.google.com/detail/x-comfort-browser/okfbbbhfbomoeobfifgjnclkdhknccgn)

- [Chrome Extensions](https://developer.chrome.com/docs/extensions?hl=zh-cn)

- Writing Extensions for Chrome: A Developer's Guide
  [åŸæ–‡](https://daily.dev/blog/writing-extensions-for-chrome-a-developers-guide)
  [ç¿»è¯‘](https://daily-dev.translate.goog/blog/writing-extensions-for-chrome-a-developers-guide?_x_tr_sl=auto&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN&_x_tr_pto=wapp)

- [Chrome æ’ä»¶å¼€å‘å…¨æ”»ç•¥](https://github.com/sxei/chrome-plugin-demo)

- [æ˜é‡‘ - ä¸‹ä¸€ä»£æµè§ˆå™¨æ’ä»¶å¼€å‘æ¡†æ¶ WXT å…¥é—¨æŒ‡å—](https://juejin.cn/post/7329724409429917705)
